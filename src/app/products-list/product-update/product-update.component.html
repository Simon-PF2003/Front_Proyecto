<div class="container-fluid mt-4">

  <!-- Encabezado superior (mobile): botón para abrir filtros -->
  <div class="d-lg-none d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Modificar Productos</h5>
    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
      <i class="fas fa-filter me-2"></i>Filtros
    </button>
  </div>

  <div class="row">
    <!-- SIDEBAR (desktop) - Componente de filtros genérico -->
    <aside class="col-lg-3 d-none d-lg-block mb-4">
      <app-filters-panel 
        [categories]="categories" 
        [brands]="brands">
      </app-filters-panel>
    </aside>

    <!-- CONTENIDO -->
    <main class="col-lg-9">
      <!-- Barra de estado + orden -->
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
        <div class="small text-muted">
          Mostrando {{ displayedProducts.length || 0 }} productos
        </div>
        <div class="d-flex align-items-center gap-2">
          <label for="sortOrder" class="me-1 small text-nowrap"><i class="fas fa-sort me-1"></i>Ordenar:</label>
          <select id="sortOrder" class="form-select form-select-sm elegant-select" style="min-width: 220px"
                  [(ngModel)]="sortOrder" (change)="sortProducts()">
            <option value="none">Sin orden</option>
            <option value="asc">Precio: Menor a Mayor</option>
            <option value="desc">Precio: Mayor a Menor</option>
            <option value="name-asc">Nombre: A-Z</option>
            <option value="name-desc">Nombre: Z-A</option>
            <option value="code-asc">Código: Menor a Mayor</option>
            <option value="code-desc">Código: Mayor a Menor</option>
          </select>
        </div>
      </div>

      <!-- Chips de filtros activos -->
      <div class="mb-3 d-flex flex-wrap gap-2">

        <!-- Categorías (multi) -->
        <span *ngFor="let c of filters.value.selectedCategories" class="filter-chip">
          Categoría: {{ getCategoryName(c) }}
          <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                  (click)="filters.removeCategory(c)"></button>
        </span>

        <!-- Marcas (multi) -->
        <span *ngFor="let b of filters.value.selectedBrands" class="filter-chip">
          Marca: {{ b }}
          <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                  (click)="filters.removeBrand(b)"></button>
        </span>

        <!-- (Opcional/compatibilidad) Marca/Categoría simples si alguna vez las usás -->
        <span *ngIf="filters.value.selectedCategory && filters.value.selectedCategory !== 'all'" class="filter-chip">
          Categoría: {{ getCategoryName(filters.value.selectedCategory) }}
          <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                  (click)="filters.set('selectedCategory', 'all')"></button>
        </span>

        <span *ngIf="filters.value.selectedBrand && filters.value.selectedBrand !== 'all'" class="filter-chip">
          Marca: {{ filters.value.selectedBrand }}
          <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                  (click)="filters.set('selectedBrand', 'all')"></button>
        </span>

        <!-- Precio -->
        <span *ngIf="filters.value.minPrice != null || filters.value.maxPrice != null" class="filter-chip">
          Precio:
          {{ (filters.value.minPrice ?? 0) | currency }}
          -
          {{ filters.value.maxPrice != null ? (filters.value.maxPrice | currency) : '∞' }}
          <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                  (click)="filters.set('minPrice', null); filters.set('maxPrice', null)"></button>
        </span>

        <!-- Stock -->
        <span *ngIf="filters.value.hasStockFilter" class="filter-chip">
          Solo con stock
          <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                  (click)="filters.set('hasStockFilter', false)"></button>
        </span>

        <!-- Reset si hay cualquier filtro activo -->
        <button
          *ngIf="
            filters.value.selectedBrands.length ||
            filters.value.selectedCategories.length ||
            (filters.value.selectedBrand && filters.value.selectedBrand!=='all') ||
            (filters.value.selectedCategory && filters.value.selectedCategory!=='all') ||
            filters.value.minPrice != null || filters.value.maxPrice != null || filters.value.hasStockFilter
          "
          class="btn btn-sm btn-outline-secondary"
          (click)="clearAllFilters()">
          Resetear todos
        </button>
      </div>

      <!-- GRID de productos -->
      <div class="row">
        <div class="col-md-6 col-lg-4 col-xl-3 mt-4" *ngFor="let product of displayedProducts">
          <div class="product-card">
            <div class="card h-100">
              <img class="card-img-top" [src]="apiUrl + '/' + product.image" alt="{{ product.desc }}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title truncate">{{ product.desc }}</h5>
                <p class="card-text truncate">Código: {{ product.code }}</p>
                <p class="card-text truncate">Marca: {{ product.brand?.brand || 'Sin marca' }}</p>
                <p class="card-text truncate">Categoría: {{ product.cat?.type || 'Sin categoría' }}</p>
                <p class="card-text">Stock: {{ product.stock }}</p>
                <p class="card-text">Stock mínimo: {{ product.stockMin }}</p>
                <p class="card-text card-price">Precio: {{ product.price | currency }}</p>
                
                <div class="mt-auto">
                  <div class="d-flex justify-content-between gap-2">
                    <button class="btn btn-warning flex-fill" (click)="modifyProduct(product)">Modificar</button>
                    <button class="btn btn-danger flex-fill" (click)="deleteProduct(product._id)">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Paginación -->
      <nav class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" style="background-color:#F8F4EC;border:1px solid #CCC9C2" (click)="changePage(currentPage - 1)">Anterior</button>
          </li>
          <li *ngFor="let page of [].constructor(totalPages); let i = index" class="page-item">
            <button class="page-link"
              [ngStyle]="currentPage === (i + 1) ? {'background-color': '#4CA7BF','border': '1px solid #CCC9C2','color':'white'} : {'background-color':'#F8F4EC','border':'1px solid #CCC9C2'}"
              (click)="changePage(i + 1)">{{ i + 1 }}</button>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <button class="page-link" style="background-color:#F8F4EC;border:1px solid #CCC9C2" (click)="changePage(currentPage + 1)">Siguiente</button>
          </li>
        </ul>
      </nav>
    </main>
  </div>

  <!-- OFFCANVAS (mobile) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title"><i class="fas fa-sliders-h me-2"></i>Filtros</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" (click)="clearAllFilters()">
          <i class="fas fa-times me-1"></i>Resetear
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
    </div>
    <div class="offcanvas-body">

      <div class="accordion" id="filtersAccordionMobile">
        <!-- Precio (mobile) -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingPriceMobile">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapsePriceMobile">
              <i class="fas fa-dollar-sign me-2"></i>Rango de Precio
            </button>
          </h2>
          <div id="collapsePriceMobile" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="input-group mb-2">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" placeholder="Mínimo"
                      [(ngModel)]="filters.value.minPrice" min="0">
              </div>
              <div class="input-group mb-2">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" placeholder="Máximo"
                      [(ngModel)]="filters.value.maxPrice" min="0">
              </div>
              <div class="d-grid">
                <button type="button" class="btn btn-soft-primary btn-sm" (click)="applyPriceFilter()">
                  <i class="fas fa-search me-1"></i>Aplicar filtro
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Categoría (mobile) -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingCategoryMobile">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseCategoryMobile">
              <i class="fas fa-layer-group me-2"></i>Categoría
            </button>
          </h2>
          <div id="collapseCategoryMobile" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="elegant-select-list" role="listbox" aria-label="Categorías">
                <button type="button" class="elegant-option"
                        *ngFor="let c of categories"
                        [class.active]="filters.value.selectedCategories.includes(c._id)"
                        (click)="filters.toggleCategory(c._id)"
                        role="option"
                        [attr.aria-selected]="filters.value.selectedCategories.includes(c._id)">
                  <span>{{ c.type }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Marca (mobile) -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingBrandMobile">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseBrandMobile">
              <i class="fas fa-tag me-2"></i>Marca
            </button>
          </h2>
          <div id="collapseBrandMobile" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="elegant-select-list" role="listbox" aria-label="Marcas">
                <button type="button" class="elegant-option"
                        *ngFor="let b of brands"
                        [class.active]="filters.value.selectedBrands.includes(b.brand)"
                        (click)="filters.toggleBrand(b.brand)"
                        role="option"
                        [attr.aria-selected]="filters.value.selectedBrands.includes(b.brand)">
                  <span>{{ b.brand }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stock (mobile) -->
      <div class="mt-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="stockFilterMobile"
                [(ngModel)]="filters.value.hasStockFilter">
          <label class="form-check-label" for="stockFilterMobile">Solo con stock</label>
        </div>
      </div>
    </div>
  </div>
</div>
