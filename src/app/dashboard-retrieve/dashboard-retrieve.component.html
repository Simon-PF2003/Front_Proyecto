<div class="container-fluid mt-4">
  <div class="row">
    <!-- SIDEBAR con filtros -->
    <aside class="col-lg-3 mb-4">
      <div class="filters-sidebar card sticky-top" style="top: 1rem;">
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #F8F4EC;">
          <span><i class="fas fa-chart-line me-2"></i>Dashboard</span>
          <button class="btn btn-outline-secondary btn-sm" (click)="resetFilters()">
            <i class="fas fa-times me-1"></i>Resetear
          </button>
        </div>

        <div class="card-body">
          <div class="accordion" id="filtersAccordion">

            <!-- Rango de fechas -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDates">
                  <i class="fas fa-calendar-alt me-2"></i>Rango de Fechas
                </button>
              </h2>
              <div id="collapseDates" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <div class="mb-2">
                    <label class="form-label small">Desde</label>
                    <input type="date" class="form-control form-control-sm" [(ngModel)]="filters.startDate">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Hasta</label>
                    <input type="date" class="form-control form-control-sm" [(ngModel)]="filters.endDate">
                  </div>
                </div>
              </div>
            </div>

            <!-- Categoría -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory">
                  <i class="fas fa-layer-group me-2"></i>Categoría
                </button>
              </h2>
              <div id="collapseCategory" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <select class="form-select form-select-sm" [(ngModel)]="filters.category">
                    <option value="">Todas las categorías</option>
                    <option *ngFor="let cat of categories" [value]="cat.type">{{ cat.type }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Marca -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand">
                  <i class="fas fa-tag me-2"></i>Marca
                </button>
              </h2>
              <div id="collapseBrand" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <select class="form-select form-select-sm" [(ngModel)]="filters.brand">
                    <option value="">Todas las marcas</option>
                    <option *ngFor="let brand of brands" [value]="brand.brand">{{ brand.brand }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Cliente -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClient">
                  <i class="fas fa-user me-2"></i>Cliente
                </button>
              </h2>
              <div id="collapseClient" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <select class="form-select form-select-sm" [(ngModel)]="filters.businessName">
                    <option value="">Todos los clientes</option>
                    <option *ngFor="let user of users" [value]="user.businessName">{{ user.businessName }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Agrupación -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGroup">
                  <i class="fas fa-clock me-2"></i>Agrupar por
                </button>
              </h2>
              <div id="collapseGroup" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <select class="form-select form-select-sm" [(ngModel)]="filters.groupBy">
                    <option value="day">Día</option>
                    <option value="week">Semana</option>
                    <option value="month">Mes</option>
                    <option value="quarter">Trimestre</option>
                    <option value="year">Año</option>
                  </select>
                </div>
              </div>
            </div>

          </div>

          <!-- Botón aplicar -->
          <div class="mt-3 d-grid">
            <button class="btn btn-primary" (click)="applyFilters()">
              <i class="fas fa-filter me-2"></i>Aplicar Filtros
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- CONTENIDO -->
    <main class="col-lg-9">
      <!-- KPIs Overview -->
      <div class="row g-3 mb-4" *ngIf="!loading.overview">
        <div class="col-md-4">
          <div class="card kpi-card">
            <div class="card-body text-center">
              <div class="kpi-icon"><i class="fas fa-box"></i></div>
              <div class="kpi-value">{{ formatNumber(overview.totalProducts) }}</div>
              <div class="kpi-title">Productos Vendidos</div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card kpi-card">
            <div class="card-body text-center">
              <div class="kpi-icon"><i class="fas fa-receipt"></i></div>
              <div class="kpi-value">{{ formatNumber(overview.totalSales) }}</div>
              <div class="kpi-title">Total Ventas</div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card kpi-card">
            <div class="card-body text-center">
              <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
              <div class="kpi-value">{{ formatCurrency(overview.totalRevenue) }}</div>
              <div class="kpi-title">Ingresos Totales</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading indicator -->
      <div *ngIf="loading.overview" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row g-3 mb-4">
        <!-- Sales History Chart -->
        <div class="col-12">
          <div class="card">
            <div class="card-header" style="background-color: #F8F4EC;">
              <i class="fas fa-chart-line me-2"></i>Historial de Ventas
            </div>
            <div class="card-body" style="height: 350px;">
              <canvas baseChart
                *ngIf="!loading.sales && salesHistory.length > 0"
                [data]="salesChartData"
                [options]="salesChartOptions"
                [type]="salesChartType">
              </canvas>
              <div *ngIf="loading.sales" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quarterly Comparison -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header" style="background-color: #F8F4EC;">
              <i class="fas fa-chart-bar me-2"></i>Comparación Trimestral
            </div>
            <div class="card-body" style="height: 300px;">
              <canvas baseChart
                *ngIf="!loading.sales && quarterlyComparison.length > 0"
                [data]="quarterlyChartData"
                [options]="quarterlyChartOptions"
                [type]="quarterlyChartType">
              </canvas>
              <div *ngIf="loading.sales" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Chart -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header" style="background-color: #F8F4EC;">
              <i class="fas fa-trophy me-2"></i>Top Productos Vendidos
            </div>
            <div class="card-body" style="height: 300px;">
              <canvas baseChart
                *ngIf="!loading.products && productsMostSold.length > 0"
                [data]="productsChartData"
                [options]="productsChartOptions"
                [type]="productsChartType">
              </canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Products Most Sold Table -->
      <div class="card mb-4">
        <div class="card-header" style="background-color: #F8F4EC;">
          <i class="fas fa-star me-2"></i>Productos Más Vendidos
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" *ngIf="!loading.products">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Marca</th>
                  <th class="text-end">Cantidad</th>
                  <th class="text-end">Ingresos</th>
                  <th class="text-center">Ventas</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of productsMostSold.slice(0, 10)">
                  <td>{{ product.productName }}</td>
                  <td><span class="badge bg-secondary">{{ product.category }}</span></td>
                  <td>{{ product.brand }}</td>
                  <td class="text-end">{{ formatNumber(product.totalQuantity) }}</td>
                  <td class="text-end">{{ formatCurrency(product.totalRevenue) }}</td>
                  <td class="text-center">{{ product.salesCount }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Profitability Section -->
      <!--<div class="card mb-4">
        <div class="card-header" style="background-color: #F8F4EC;">
          <i class="fas fa-chart-pie me-2"></i>Rentabilidad por Producto
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" *ngIf="!loading.profitability">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Marca</th>
                  <th class="text-end">Ingresos</th>
                  <th class="text-end">Costo</th>
                  <th class="text-end">Ganancia</th>
                  <th class="text-end">Margen %</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of profitabilityProducts.slice(0, 10)">
                  <td>{{ product.productName }}</td>
                  <td><span class="badge bg-secondary">{{ product.category }}</span></td>
                  <td>{{ product.brand }}</td>
                  <td class="text-end">{{ formatCurrency(product.totalRevenue) }}</td>
                  <td class="text-end">{{ formatCurrency(product.totalCost) }}</td>
                  <td class="text-end">{{ formatCurrency(product.totalProfit) }}</td>
                  <td class="text-end"><strong>{{ product.profitMargin.toFixed(2) }}%</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>-->

      <!-- Customers Analysis Section -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header" style="background-color: #F8F4EC;">
              <i class="fas fa-users me-2"></i>Clientes Registrados
            </div>
            <div class="card-body text-center">
              <div class="display-4 text-primary fw-bold">{{ registeredClients.total }}</div>
              <small class="text-muted">Total de clientes</small>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-header" style="background-color: #F8F4EC;">
              <i class="fas fa-user-check me-2"></i>Clientes Activos
            </div>
            <div class="card-body text-center">
              <div class="display-4 text-success fw-bold">{{ activeClients.total }}</div>
              <small class="text-muted">Último mes</small>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-header" style="background-color: #F8F4EC;">
              <i class="fas fa-star me-2"></i>Clientes VIP
            </div>
            <div class="card-body text-center">
              <div class="display-4 text-warning fw-bold">{{ importantClients.stats.totalVIPClients }}</div>
              <small class="text-muted">Clientes destacados</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Client Rankings -->
      <div class="card mb-4">
        <div class="card-header" style="background-color: #F8F4EC;">
          <i class="fas fa-medal me-2"></i>Top Clientes por Compras
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" *ngIf="!loading.customers">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Posición</th>
                  <th>Cliente</th>
                  <th>Email</th>
                  <th class="text-end">Cantidad Productos</th>
                  <th class="text-center">Total Compras</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let client of clientRankings.byQuantity.slice(0, 10); let i = index">
                  <td>
                    <span class="badge" [class.bg-warning]="i === 0" [class.bg-secondary]="i > 0">
                      {{ i + 1 }}
                    </span>
                  </td>
                  <td>{{ client.businessName }}</td>
                  <td><small class="text-muted">{{ client.email }}</small></td>
                  <td class="text-end"><strong>{{ formatNumber(client.totalQuantity || 0) }}</strong></td>
                  <td class="text-center">{{ client.salesCount }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Important Clients (VIP) -->
      <div class="card mb-4">
        <div class="card-header" style="background-color: #F8F4EC;">
          <i class="fas fa-crown me-2"></i>Clientes VIP
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" *ngIf="!loading.customers">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Email</th>
                  <th class="text-center">Compras</th>
                  <th class="text-end">Total Gastado</th>
                  <th class="text-end">Promedio/Compra</th>
                  <th class="text-center">VIP Score</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let client of importantClients.clients.slice(0, 15)">
                  <td>{{ client.businessName }}</td>
                  <td><small class="text-muted">{{ client.email }}</small></td>
                  <td class="text-center">{{ client.purchaseCount }}</td>
                  <td class="text-end">{{ formatCurrency(client.totalSpent) }}</td>
                  <td class="text-end">{{ formatCurrency(client.avgTicket) }}</td>
                  <td class="text-center"><span class="badge bg-warning">{{ client.vipScore.toFixed(1) }}</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
