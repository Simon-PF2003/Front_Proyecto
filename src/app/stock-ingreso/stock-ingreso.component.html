<div class="container mt-4">
  <!-- Vista de Proveedores -->
  <div *ngIf="currentView === 'suppliers'">
    <h2 class="mb-4">Seleccionar Proveedor para Orden de Compra</h2>

    <!-- Buscador de proveedores -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="searchSupplier" class="form-label">Buscar por CUIT o razón social:</label>
        <input type="text" id="searchSupplier" class="form-control" [(ngModel)]="searchSupplierTerm" 
               (keyup.enter)="onSearchSupplier()" placeholder="Ingrese CUIT o razón social">
      </div>
      <div class="col-md-4 align-self-end">
        <button class="btn btn-primary" (click)="onSearchSupplier()">Buscar</button>
      </div>
    </div>

    <div *ngIf="suppliers.length === 0" class="alert alert-info">
      No se encontraron proveedores.
    </div>

    <div class="row">
      <div class="col-md-4" *ngFor="let supplier of displayedSuppliers">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">{{ supplier.businessName }}</h5>
            <p class="card-text">CUIT: {{ supplier.cuit }}</p>
            <p class="card-text">Dirección: {{ supplier.address }}</p>
            <p class="card-text">Teléfono: {{ supplier.phoneNumber }}</p>
            <button class="btn btn-primary w-100" (click)="selectSupplier(supplier)">
              Generar Orden de Compra
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginación de proveedores -->
    <nav class="mt-4" *ngIf="supplierTotalPages > 1">
      <ul class="pagination justify-content-center"> 
        <li class="page-item" [class.disabled]="supplierCurrentPage === 1">
          <button class="page-link" style="background-color: #F8F4EC; border: 1px solid #CCC9C2" 
                  (click)="changeSupplierPage(supplierCurrentPage - 1)">Anterior</button>
        </li>
        <li *ngFor="let page of [].constructor(supplierTotalPages); let i = index" class="page-item">
          <button 
            class="page-link" 
            [ngStyle]="supplierCurrentPage === (i + 1) ? {'background-color': '#4CA7BF', 'border': '1px solid #CCC9C2', 'color': 'white'} : {'background-color': '#F8F4EC', 'border': '1px solid #CCC9C2'}"
            (click)="changeSupplierPage(i + 1)">
            {{ i + 1 }}
          </button>
        </li>
        <li class="page-item" [class.disabled]="supplierCurrentPage === supplierTotalPages">
          <button class="page-link" style="background-color: #F8F4EC; border: 1px solid #CCC9C2;" 
                  (click)="changeSupplierPage(supplierCurrentPage + 1)">Siguiente</button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Vista de Productos -->
<div *ngIf="currentView === 'products'" class="container-fluid mt-4">
    <!-- Header con información del proveedor y botón volver -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2>Orden de Compra - {{ selectedSupplier.businessName }}</h2>
          <p class="text-muted mb-0">CUIT: {{ selectedSupplier.cuit }} | Teléfono: {{ selectedSupplier.phoneNumber }}</p>
        </div>
        <button class="btn btn-secondary" (click)="backToSuppliers()">
          <i class="fas fa-arrow-left me-2"></i>Volver a Proveedores
        </button>
      </div>

      <!-- Botones de acción -->
      <div class="d-flex justify-content-end mb-3" *ngIf="products.length > 0">
        <button class="btn btn-success me-2" (click)="ingresarStock()">
          <i class="fas fa-plus me-2"></i>Ingresar Stock
        </button>
        <button class="btn btn-primary" (click)="generarOrdenDeCompra()">
          <i class="fas fa-file-invoice me-2"></i>Generar Orden de Compra
        </button>
      </div>

      <!-- Botón de filtros para móvil -->
      <div class="d-lg-none d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Filtros</h5>
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
          <i class="fas fa-filter me-2"></i>Filtros
        </button>
      </div>

      <div class="row">
        <!-- SIDEBAR DE FILTROS (desktop) -->
        <aside class="col-lg-3 d-none d-lg-block mb-4">
          <div class="filters-sidebar card sticky-top" style="top: 1rem;">
            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #F8F4EC;">
              <span><i class="fas fa-sliders-h me-2"></i>Filtros</span>
              <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearAllFilters()">
                <i class="fas fa-times me-1"></i>Resetear
              </button>
            </div>

            <div class="card-body">
              <div class="accordion" id="filtersAccordion">

                <!-- Precio -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingPrice">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrice">
                      <i class="fas fa-dollar-sign me-2"></i>Rango de Precio
                    </button>
                  </h2>
                  <div id="collapsePrice" class="accordion-collapse collapse">
                    <div class="accordion-body">
                      <div class="input-group mb-2">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" placeholder="Mínimo"
                              [(ngModel)]="minPrice" (keydown.enter)="applyPriceFilter()" min="0">
                      </div>
                      <div class="input-group mb-2">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" placeholder="Máximo"
                              [(ngModel)]="maxPrice" (keydown.enter)="applyPriceFilter()" min="0">
                      </div>
                      <div class="d-grid">
                        <button type="button" class="btn btn-soft-primary btn-sm" (click)="applyPriceFilter()">
                          <i class="fas fa-search me-1"></i>Aplicar filtro
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Categoría -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingCategory">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory">
                      <i class="fas fa-layer-group me-2"></i>Categoría
                    </button>
                  </h2>
                  <div id="collapseCategory" class="accordion-collapse collapse">
                    <div class="accordion-body">
                      <div class="elegant-select-list" role="listbox">
                        <button type="button" class="elegant-option"
                          *ngFor="let c of categories"
                          [class.active]="selectedCategories.includes(c._id)"
                          (click)="toggleCategoryItem(c._id)">
                          <span>{{ c.type }}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Marca -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingBrand">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand">
                      <i class="fas fa-tag me-2"></i>Marca
                    </button>
                  </h2>
                  <div id="collapseBrand" class="accordion-collapse collapse">
                    <div class="accordion-body">
                      <div class="elegant-select-list" role="listbox">
                        <button type="button" class="elegant-option"
                          *ngFor="let b of brands"
                          [class.active]="selectedBrands.includes(b.brand)"
                          (click)="toggleBrandItem(b.brand)">
                          <span>{{ b.brand }}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Stock -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingStock">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStock">
                      <i class="fas fa-boxes me-2"></i>Filtro de Stock
                    </button>
                  </h2>
                  <div id="collapseStock" class="accordion-collapse collapse">
                    <div class="accordion-body">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="lowStockFilter"
                               [(ngModel)]="hasStockFilter" (change)="onLowStockFilterChange()">
                        <label class="form-check-label" for="lowStockFilter">
                          <i class="fas fa-exclamation-triangle me-2"></i>Solo stock bajo
                        </label>
                      </div>
                      <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="noStockFilter"
                               [(ngModel)]="noStockFilter" (change)="onNoStockFilterChange()">
                        <label class="form-check-label" for="noStockFilter">
                          <i class="fas fa-times-circle me-2"></i>Solo sin stock
                        </label>
                      </div>
                    </div>
                  </div>
                </div>              
              </div>
            </div>
          </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="col-lg-9">
          <!-- Barra de estado + orden -->
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
            <div class="small text-muted">
              Mostrando {{ displayedProducts.length || 0 }} productos
            </div>
            <div class="d-flex align-items-center gap-2">
              <label for="sortOrder" class="me-1 small text-nowrap">
                <i class="fas fa-sort me-1"></i>Ordenar:
              </label>
              <select id="sortOrder" class="form-select form-select-sm elegant-select" style="min-width: 200px"
                      [(ngModel)]="sortOrder" (change)="sortProducts()">
                <option value="none">Sin orden</option>
                <option value="asc">Precio: Menor a Mayor</option>
                <option value="desc">Precio: Mayor a Menor</option>
                <option value="name-asc">Nombre: A-Z</option>
                <option value="name-desc">Nombre: Z-A</option>
                <option value="stock-asc">Stock: Menor a Mayor</option>
                <option value="stock-desc">Stock: Mayor a Menor</option>
              </select>
            </div>
          </div>

          <!-- Chips de filtros activos -->
          <div class="mb-3 d-flex flex-wrap gap-2">
            <!-- Categorías (multi) -->
            <span *ngFor="let catId of selectedCategories" class="filter-chip">
              Categoría: {{ getCategoryName(catId) }}
              <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                      (click)="toggleCategory(catId, false)"></button>
            </span>

            <!-- Marcas (multi) -->
            <span *ngFor="let brand of selectedBrands" class="filter-chip">
              Marca: {{ brand }}
              <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                      (click)="toggleBrand(brand, false)"></button>
            </span>

            <!-- Precio -->
            <span *ngIf="minPrice !== null || maxPrice !== null" class="filter-chip">
              Precio: {{ (minPrice || 0) | currency }} - {{ maxPrice !== null ? (maxPrice | currency) : '∞' }}
              <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                      (click)="minPrice=null; maxPrice=null; applyPriceFilter()"></button>
            </span>

            <!-- Stock -->
            <span *ngIf="hasStockFilter" class="filter-chip">
              Solo stock bajo
              <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                      (click)="hasStockFilter=false; applyAllFilters()"></button>
            </span>

            <span *ngIf="noStockFilter" class="filter-chip">
              Solo sin stock
              <button type="button" class="btn-close btn-close-white btn-close-sm ms-2"
                      (click)="noStockFilter=false; applyAllFilters()"></button>
            </span>

            <!-- Reset si hay cualquier filtro activo -->
            <button *ngIf="selectedCategories.length || selectedBrands.length || minPrice !== null || maxPrice !== null || hasStockFilter || noStockFilter"
                    class="btn btn-sm btn-outline-secondary" (click)="clearAllFilters()">
              Resetear todos
            </button>
          </div>

        <!-- Sin resultados -->
        <div *ngIf="products.length === 0" class="alert alert-info text-center">
          <i class="fas fa-info-circle me-2"></i>
          <strong>No hay productos disponibles</strong>
          <p class="mb-0 mt-2">
            <small>El proveedor "{{ selectedSupplier.businessName }}" no tiene productos que cumplan con los filtros aplicados.</small>
          </p>
          <button type="button" class="btn btn-outline-primary btn-sm mt-2" (click)="clearAllFilters()">
            <i class="fas fa-times me-1"></i>Limpiar filtros
          </button>
        </div>

        <!-- GRID de productos -->
        <div class="row" *ngIf="displayedProducts.length > 0">
          <div class="col-md-6 col-lg-4 col-xl-3 mt-4" *ngFor="let product of displayedProducts">
            <div class="product-card" [ngClass]="{'low-stock': product.isLowStock && !product.isNoStock, 'no-stock': product.isNoStock}">
              <div class="card h-100">
                <div class="position-relative">
                  <img class="card-img-top" [src]="'http://localhost:3000/' + product.image" alt="{{ product.desc }}">
                  <!-- Badge de stock bajo -->
                  <div *ngIf="product.isLowStock && !product.isNoStock" class="position-absolute top-0 end-0 m-2">
                    <span class="badge bg-warning text-dark">Stock Bajo</span>
                  </div>
                  <!-- Badge de sin stock -->
                  <div *ngIf="product.isNoStock" class="position-absolute top-0 end-0 m-2">
                    <span class="badge bg-danger text-white">Sin Stock</span>
                  </div>
                </div>
                
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title truncate">{{ product.desc }}</h5>
                  <p class="card-text truncate">Código: {{ product.code }}</p>
                  <p class="card-text truncate">Marca: {{ product.brand?.brand || 'Sin marca' }}</p>
                  <p class="card-text truncate">Categoría: {{ product.cat?.type || '' }}</p>
                  
                  <!-- Stock con colores -->
                  <p class="card-text" [ngClass]="product.isNoStock ? 'text-danger' : (product.isLowStock ? 'text-warning' : '')">
                    Stock: {{ product.stock }}
                    <span class="small text-muted">(Mín: {{ product.stockMin }})</span>
                  </p>

                  <div class="mt-auto">
                    <p class="card-price mb-2">{{ product.price | currency }}</p>
                    
                    <!-- Input cantidad -->
                    <div class="form-group">
                      <label for="stockInput{{ product._id }}" class="form-label small">Cantidad a solicitar:</label>
                      <input type="number" id="stockInput{{ product._id }}" 
                             class="form-control form-control-sm"
                             [(ngModel)]="product.quantityToBuy" min="0" placeholder="0">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Paginación -->
        <nav class="mt-4" *ngIf="totalPages > 1">
          <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" style="background-color: #F8F4EC; border: 1px solid #CCC9C2" 
                      (click)="changePage(currentPage - 1)">Anterior</button>
            </li>
            <li *ngFor="let page of [].constructor(totalPages); let i = index" class="page-item">
              <button class="page-link"
                      [ngStyle]="currentPage === (i + 1) ? {'background-color': '#4CA7BF', 'border': '1px solid #CCC9C2', 'color': 'white'} : {'background-color': '#F8F4EC', 'border': '1px solid #CCC9C2'}"
                      (click)="changePage(i + 1)">{{ i + 1 }}</button>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" style="background-color: #F8F4EC; border: 1px solid #CCC9C2;" 
                      (click)="changePage(currentPage + 1)">Siguiente</button>
            </li>
          </ul>
        </nav>
      </main>
    </div>

    <!-- OFFCANVAS (mobile) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title"><i class="fas fa-sliders-h me-2"></i>Filtros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">

        <!-- Acordeones MOBILE (IDs propios para evitar conflictos) -->
        <div class="accordion" id="filtersAccordionMobile">

          <!-- Precio (mobile) -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingPriceMobile">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapsePriceMobile"
                      aria-expanded="false" aria-controls="collapsePriceMobile">
                <i class="fas fa-dollar-sign me-2"></i>Rango de Precio
              </button>
            </h2>
            <div id="collapsePriceMobile" class="accordion-collapse collapse" aria-labelledby="headingPriceMobile">
              <div class="accordion-body">
                <div class="input-group mb-2">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" placeholder="Mínimo"
                        [(ngModel)]="minPrice" (keydown.enter)="applyPriceFilter()" min="0">
                </div>
                <div class="input-group mb-2">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" placeholder="Máximo"
                        [(ngModel)]="maxPrice" (keydown.enter)="applyPriceFilter()" min="0">
                </div>
                <div class="d-grid">
                  <button type="button" class="btn btn-soft-primary btn-sm" (click)="applyPriceFilter()">
                    <i class="fas fa-search me-1"></i>Aplicar filtro
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Categoría (mobile) -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingCategoryMobile">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapseCategoryMobile"
                      aria-expanded="false" aria-controls="collapseCategoryMobile">
                <i class="fas fa-layer-group me-2"></i>Categoría
              </button>
            </h2>
            <div id="collapseCategoryMobile" class="accordion-collapse collapse" aria-labelledby="headingCategoryMobile">
              <div class="accordion-body">
                <div class="elegant-select-list" role="listbox" aria-label="Categorías">
                  <button type="button"
                          class="elegant-option"
                          *ngFor="let c of categories"
                          [class.active]="selectedCategories.includes(c._id)"
                          (click)="toggleCategoryItem(c._id)"
                          role="option"
                          [attr.aria-selected]="selectedCategories.includes(c._id)">
                    <span>{{ c.type }}</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Marca (mobile) -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingBrandMobile">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapseBrandMobile"
                      aria-expanded="false" aria-controls="collapseBrandMobile">
                <i class="fas fa-tag me-2"></i>Marca
              </button>
            </h2>
            <div id="collapseBrandMobile" class="accordion-collapse collapse" aria-labelledby="headingBrandMobile">
              <div class="accordion-body">
                <div class="elegant-select-list" role="listbox" aria-label="Marcas">
                  <button type="button"
                          class="elegant-option"
                          *ngFor="let b of brands"
                          [class.active]="selectedBrands.includes(b.brand)"
                          (click)="toggleBrandItem(b.brand)"
                          role="option"
                          [attr.aria-selected]="selectedBrands.includes(b.brand)">
                    <span>{{ b.brand }}</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Stock (mobile) -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingStockMobile">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapseStockMobile"
                      aria-expanded="false" aria-controls="collapseStockMobile">
                <i class="fas fa-boxes me-2"></i>Filtro de Stock
              </button>
            </h2>
            <div id="collapseStockMobile" class="accordion-collapse collapse" aria-labelledby="headingStockMobile">
              <div class="accordion-body">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="lowStockFilterMobile"
                         [(ngModel)]="hasStockFilter" (change)="onLowStockFilterChange()">
                  <label class="form-check-label" for="lowStockFilterMobile">
                    <i class="fas fa-exclamation-triangle me-2"></i>Solo stock bajo
                  </label>
                </div>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="noStockFilterMobile"
                         [(ngModel)]="noStockFilter" (change)="onNoStockFilterChange()">
                  <label class="form-check-label" for="noStockFilterMobile">
                    <i class="fas fa-times-circle me-2"></i>Solo sin stock
                  </label>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Acciones -->
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-soft-secondary" (click)="clearAllFilters()">
            <i class="fas fa-times me-1"></i>Resetear
          </button>
        </div>
      </div>
    </div>
</div>
